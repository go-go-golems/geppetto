---
Title: 'Diary: 5.1 Opaque Handle Implementation'
Ticket: GP-01-JS-IMPROVEMENTS
Status: ""
Topics:
    - geppetto
    - javascript
    - goja
    - api-design
DocType: reference
Intent: ""
Owners: []
RelatedFiles:
    - Path: pkg/js/modules/geppetto/module.go
      Note: Updated hidden reference attachment semantics
    - Path: pkg/js/modules/geppetto/api_engines.go
      Note: Engine ref handling now lives in split API files
    - Path: pkg/js/modules/geppetto/module_test.go
      Note: Added coverage for opaque/non-enumerable ref behavior
ExternalSources: []
Summary: 'Detailed implementation diary for 5.1: opaque handle protection and improved reference error messages.'
LastUpdated: 0001-01-01T00:00:00Z
WhatFor: ""
WhenToUse: ""
---

# Diary: 5.1 Opaque Handle Implementation

## 2026-02-20

### Goal

Replace the plain `o.Set(hiddenRefKey, ref)` in `attachRef()` with `DefineDataProperty`
to make `__geppetto_ref` non-enumerable, non-writable, non-configurable. Also improve
error messages in `requireEngineRef()` and `requireToolRegistry()`.

### Starting state

- Branch: `task/geppetto-js`, 1 commit ahead of origin
- `module.go:124-126`: `attachRef()` uses plain `o.Set(hiddenRefKey, ref)`
- `module.go:128-139`: `getRef()` reads via `obj.Get(hiddenRefKey)` — no changes needed
- `api.go:911-921`: `requireEngineRef()` — error: `"expected engine reference"` (no type info)
- `api.go:923-933`: `requireToolRegistry()` — error: `"expected tool registry reference"` (no type info)
- 6 call sites for `attachRef()`: api.go:187, 308, 1125, 1208, 1225, 1308 — all go through the single function
- Existing tests: `module_test.go` with 7 test functions covering session, middleware, tools, engines

### Step 1: Change `attachRef()` to use `DefineDataProperty`

Changed `module.go:124-126`.

**First attempt (FAILED):**
```go
func (m *moduleRuntime) attachRef(o *goja.Object, ref any) {
    _ = o.DefineDataProperty(hiddenRefKey, m.vm.ToValue(ref),
        goja.FLAG_FALSE, goja.FLAG_FALSE, goja.FLAG_FALSE,
    )
}
```
This broke 2 tests (`TestSessionRunWithEchoEngine`, `TestSessionHistoryInspection...`)
because `m.vm.ToValue(ref)` wraps Go struct pointers (`*engineRef`) into goja proxy
objects. When `getRef()` later calls `.Export()` on the proxy, it returns
`map[string]interface{}` instead of the original `*engineRef` pointer.

**Root cause:** `m.vm.ToValue()` introspects Go structs and creates field-level
proxies. The original `o.Set(hiddenRefKey, ref)` stored the raw Go value without
introspection.

**Working approach (two-step):**
```go
func (m *moduleRuntime) attachRef(o *goja.Object, ref any) {
    // Set first to preserve the raw Go pointer (o.Set stores as-is)
    _ = o.Set(hiddenRefKey, ref)
    // Then redefine to make non-enumerable/non-writable/non-configurable
    _ = o.DefineDataProperty(hiddenRefKey, o.Get(hiddenRefKey),
        goja.FLAG_FALSE, goja.FLAG_FALSE, goja.FLAG_FALSE,
    )
}
```

**Second failure (same tests):** Still broke because `applyBuilderOptions()` calls
`v.Export()` on the entire options object, which serializes all properties to a Go
map. With the old enumerable `__geppetto_ref`, the key was included in the export.
Now that it's non-enumerable, `Export()` skips it, so the ref is lost.

**Fix:** Refactored `applyBuilderOptions()` to read ref-carrying properties (engine,
middlewares, tools) directly from the goja object via `obj.Get("engine")` instead
of going through `v.Export()` → `decodeMap()`. This preserves the non-enumerable
properties. The code already used this pattern for `toolLoop` and `toolHooks`.

### Lesson learned (important for future work!)

**goja `Export()` strips non-enumerable properties.** Any code path that:
1. Calls `.Export()` on an object containing opaque refs
2. Then wraps the exported Go value back with `m.vm.ToValue()`
...will lose the ref. Always read ref-carrying properties directly from the goja
object using `obj.Get("propName")`.

### Step 2: Improve error messages

Changed `api.go:911-933` to include the actual type received:
- `requireEngineRef`: `"expected engine reference, got %T (value: %v)"`
- `requireToolRegistry`: `"expected tool registry reference, got %T (value: %v)"`

### Step 3: Add test for non-enumerability

Added `TestOpaqueRefHidden` to verify:
- `Object.keys(engine)` does not include `__geppetto_ref`
- `JSON.stringify(engine)` does not leak it
- Overwriting `engine.__geppetto_ref = 42` silently fails (non-writable)
- The engine still works (can be used to build a session and run inference)

### Step 4: Run existing tests

Ran `go test ./geppetto/pkg/js/modules/geppetto/ -v` — all tests pass.

### Verification checklist

- [x] `attachRef()` uses `DefineDataProperty` with all flags FALSE
- [x] `getRef()` unchanged — reads non-enumerable properties fine
- [x] All 6 `attachRef()` call sites unchanged — they call the same function
- [x] Error messages include `%T` and `%v` for debugging
- [x] New test verifies non-enumerability, non-writability, and continued functionality
- [x] All existing tests pass
