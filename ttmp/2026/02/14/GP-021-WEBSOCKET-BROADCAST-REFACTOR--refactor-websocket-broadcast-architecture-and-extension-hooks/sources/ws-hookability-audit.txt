# Hookability Audit

## Existing explicit extension hooks in webchat
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/timeline_registry.go:28:// RegisterTimelineHandler registers a handler for a SEM event type.
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/timeline_registry.go:29:func RegisterTimelineHandler(eventType string, handler TimelineSemHandler) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/timeline_upsert.go:11:	if r != nil && r.timelineUpsertHookOverride != nil {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/timeline_upsert.go:12:		return r.timelineUpsertHookOverride(conv)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/types.go:116:	engineFromReqBuilder EngineFromReqBuilder
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/types.go:120:	timelineUpsertHookOverride func(*Conversation) func(entity *timelinepb.TimelineEntityV1, version uint64)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req_test.go:21:func TestDefaultEngineFromReqBuilder_Chat_ProfilePrecedence(t *testing.T) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req_test.go:31:	b := NewDefaultEngineFromReqBuilder(profiles, lookup)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req_test.go:64:func TestDefaultEngineFromReqBuilder_Chat_GeneratesConvIDWhenMissing(t *testing.T) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req_test.go:67:	b := NewDefaultEngineFromReqBuilder(profiles, stubConversationLookup{})
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req_test.go:79:func TestDefaultEngineFromReqBuilder_WS_ProfilePrecedence(t *testing.T) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req_test.go:89:	b := NewDefaultEngineFromReqBuilder(profiles, lookup)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:15:// RouterOption configures optional dependencies for a Router.
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:16:type RouterOption func(*Router) error
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:18:func WithEngineFromReqBuilder(b EngineFromReqBuilder) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:28:func WithWebSocketUpgrader(u websocket.Upgrader) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:35:func WithProfileRegistry(reg ProfileRegistry) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:45:func WithConvManager(cm *ConvManager) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:55:func WithEventRouter(er *events.EventRouter) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:65:func WithBuildSubscriber(fn func(convID string) (message.Subscriber, bool, error)) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:75:func WithTimelineUpsertHook(fn func(*Conversation) func(entity *timelinepb.TimelineEntityV1, version uint64)) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:80:		r.timelineUpsertHookOverride = fn
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:85:func WithStepController(sc *toolloop.StepController) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:95:func WithDB(db *sql.DB) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:102:func WithTimelineStore(s chatstore.TimelineStore) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:116:func WithTurnStore(s chatstore.TurnStore) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:126:// WithEventSinkWrapper allows callers to wrap the default event sink (e.g., FilteringSink).
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:127:func WithEventSinkWrapper(fn EventSinkWrapper) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router_options.go:139:func WithDebugRoutesEnabled(enabled bool) RouterOption {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router.go:57:func NewRouter(ctx context.Context, parsed *values.Values, staticFS fs.FS, opts ...RouterOption) (*Router, error) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router.go:160:		r.engineFromReqBuilder = NewDefaultEngineFromReqBuilder(r.profiles, r.cm)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router.go:407:			b = NewDefaultEngineFromReqBuilder(r.profiles, r.cm)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router.go:520:			b = NewDefaultEngineFromReqBuilder(r.profiles, r.cm)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:28:// EngineFromReqBuilder resolves request policy (conv/profile/overrides) for both HTTP and WS handlers.
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:29:type EngineFromReqBuilder interface {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:58:type DefaultEngineFromReqBuilder struct {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:63:func NewDefaultEngineFromReqBuilder(profiles ProfileRegistry, conversations ConversationLookup) *DefaultEngineFromReqBuilder {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:64:	return &DefaultEngineFromReqBuilder{profiles: profiles, conversations: conversations}
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:67:func (b *DefaultEngineFromReqBuilder) BuildEngineFromReq(req *http.Request) (EngineBuildInput, *ChatRequestBody, error) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:83:func (b *DefaultEngineFromReqBuilder) buildFromWSReq(req *http.Request) (EngineBuildInput, error) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/engine_from_req.go:109:func (b *DefaultEngineFromReqBuilder) buildFromChatReq(req *http.Request) (EngineBuildInput, *ChatRequestBody, error) {

## Areas where direct ConnectionPool access is currently required
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/timeline_upsert.go:48:		conv.pool.Broadcast(b)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:28:func (c *poolClient) TrySend(data []byte) bool {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:52:type ConnectionPool struct {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:121:		if !client.TrySend(data) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:123:			cp.dropClient(client)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:138:	if !client.TrySend(data) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:140:		cp.dropClient(client)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:199:			cp.dropClient(client)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool.go:205:func (cp *ConnectionPool) dropClient(client *poolClient) {
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router.go:459:				conv.pool.SendToOne(conn, b)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/router.go:504:							conv.pool.SendToOne(conn, b)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/conversation.go:228:						c.pool.Broadcast(frame)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/conversation.go:297:				conv.pool.Broadcast(frame)
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool_test.go:63:	pool.Broadcast([]byte("one"))
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool_test.go:64:	pool.Broadcast([]byte("two"))
/home/manuel/workspaces/2026-02-13/mv-debug-ui-geppetto/pinocchio/pkg/webchat/connection_pool_test.go:65:	pool.Broadcast([]byte("three"))

## Debug API data sources relevant to websocket bootstrap/catch-up
73:				bufferedEvents = len(conv.semBuf.Snapshot())
147:			bufferedEvents = len(conv.semBuf.Snapshot())
174:	mux.HandleFunc("/api/debug/events/", func(w http.ResponseWriter, r0 *http.Request) {
202:		if s := strings.TrimSpace(r0.URL.Query().Get("since_seq")); s != "" {
278:			"since_seq": sinceSeq,
422:		if s := strings.TrimSpace(r0.URL.Query().Get("since_version")); s != "" {
458:	mux.HandleFunc("/api/debug/timeline", timelineHandler)
459:	mux.HandleFunc("/api/debug/timeline/", timelineHandler)
480:		if s := strings.TrimSpace(r0.URL.Query().Get("since_ms")); s != "" {
513:			"since_ms":   sinceMs,
521:	mux.HandleFunc("/api/debug/turns", turnsHandler)
522:	mux.HandleFunc("/api/debug/turns/", turnsHandler)
